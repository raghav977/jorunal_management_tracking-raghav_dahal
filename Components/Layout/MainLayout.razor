@inherits LayoutComponentBase
@using MauiApp3.Services
@inject AppState AppState
@inject IThemeService ThemeService
@inject NavigationManager Nav
@implements IDisposable

@if (!AppState.IsUnlocked)
{
    <div class="auth-redirect">
        <p>Redirecting to unlock...</p>
    </div>
}
else
{
    <div class="page @AppState.CurrentTheme">
        <div class="sidebar">
            <NavMenu />
        </div>

        <main>
            <div class="top-row">
                <span class="app-title">Journal</span>
                <button class="lock-app-btn" @onclick="LockApp" title="Lock App">🔒</button>
            </div>

            <article class="content">
                @Body
            </article>
        </main>
    </div>
}

@code {
    private bool _initialized;

    protected override async Task OnInitializedAsync()
    {
        AppState.OnChange += HandleStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;
            
            if (!AppState.IsUnlocked)
            {
                Nav.NavigateTo("/");
            }
            else
            {
                // Load saved theme
                var themeSettings = await ThemeService.GetThemeAsync();
                AppState.SetTheme(themeSettings.ThemeName);
            }
        }
    }

    private void HandleStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void LockApp()
    {
        AppState.Lock();
        Nav.NavigateTo("/");
    }

    public void Dispose()
    {
        AppState.OnChange -= HandleStateChanged;
    }
}
