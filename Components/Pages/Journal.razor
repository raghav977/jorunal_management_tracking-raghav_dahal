@page "/journal"
@using MauiApp3.Models
@using MauiApp3.Services
@inject IJournalService JournalService
@inject ITagService TagService
@inject NavigationManager Nav

<div class="journal-page">
    <div class="journal-header">
        <h1>Journal</h1>
        <button class="btn-primary" @onclick="NewEntry">+ New Entry</button>
    </div>

    <div class="filter-bar">
        <input type="text" 
               class="search-input" 
               placeholder="Search entries..." 
               @bind="searchTerm" 
               @bind:event="oninput"
               @onkeydown="HandleSearchKeyDown" />
        <button class="btn-secondary btn-sm" @onclick="Search">Search</button>
        
        <select class="filter-select" @onchange="OnMoodFilterChanged">
            <option value="">All Moods</option>
            @foreach (var mood in Enum.GetValues<MoodType>())
            {
                <option value="@mood">@GetMoodEmoji(mood) @mood</option>
            }
        </select>

        <select class="filter-select" @onchange="OnTagFilterChanged">
            <option value="">All Tags</option>
            @foreach (var tag in availableTags)
            {
                <option value="@tag.Id">@tag.Name</option>
            }
        </select>

        @if (hasFilters)
        {
            <button class="btn-secondary btn-sm" @onclick="ClearFilters">Clear</button>
        }
    </div>

    @if (isLoading)
    {
        <div class="loading">Loading entries...</div>
    }
    else if (!entries.Any())
    {
        <div class="empty-state">
            <span class="empty-icon">üìù</span>
            <p>@(hasFilters ? "No entries match your filters." : "No journal entries yet.")</p>
            @if (!hasFilters)
            {
                <button class="btn-primary" @onclick="NewEntry">Create your first entry</button>
            }
        </div>
    }
    else
    {
        <div class="entries-list">
            @foreach (var entry in entries)
            {
                <div class="entry-card" @onclick="() => ViewEntry(entry.Id)">
                    <div class="entry-mood-badge">@GetMoodEmoji(entry.Mood)</div>
                    <div class="entry-content">
                        <h3>@entry.Title</h3>
                        <p class="entry-preview-text">@TruncateContent(entry.Content)</p>
                        <div class="entry-meta">
                            <span class="entry-date">@entry.EntryDate.ToString("MMM dd, yyyy")</span>
                            @if (entry.JournalEntryTags?.Any() == true)
                            {
                                <span class="entry-tags">
                                    @foreach (var jt in entry.JournalEntryTags.Take(3))
                                    {
                                        <span class="mini-tag">@jt.Tag?.Name</span>
                                    }
                                </span>
                            }
                        </div>
                    </div>
                    <div class="entry-actions">
                        <button class="icon-btn" @onclick:stopPropagation @onclick="() => EditEntry(entry.Id)" title="Edit">‚úèÔ∏è</button>
                        <button class="icon-btn danger" @onclick:stopPropagation @onclick="() => DeleteEntry(entry.Id)" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            }
        </div>

        @if (totalPages > 1)
        {
            <div class="pagination">
                <button class="btn-secondary btn-sm" disabled="@(currentPage <= 1)" @onclick="PreviousPage">‚Üê Prev</button>
                <span class="page-info">Page @currentPage of @totalPages</span>
                <button class="btn-secondary btn-sm" disabled="@(currentPage >= totalPages)" @onclick="NextPage">Next ‚Üí</button>
            </div>
        }
    }
</div>

@code {
    private List<JournalEntry> entries = new();
    private List<Tag> availableTags = new();
    private bool isLoading = true;
    private string searchTerm = "";
    private MoodType? selectedMood;
    private int? selectedTagId;
    private int currentPage = 1;
    private int pageSize = 2;
    private int totalPages = 1;
    private int totalCount = 0;

    private bool hasFilters => selectedMood.HasValue || selectedTagId.HasValue || !string.IsNullOrWhiteSpace(searchTerm);

    protected override async Task OnInitializedAsync()
    {
        availableTags = await TagService.GetAllTagsAsync();
        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        isLoading = true;
        var result = await JournalService.GetEntriesPagedAsync(
            currentPage, 
            pageSize, 
            selectedMood, 
            selectedTagId, 
            string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm);
        
        entries = result.Entries;
        totalCount = result.TotalCount;
        totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
        isLoading = false;
    }

    private async Task HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Search();
        }
    }

    private async Task Search()
    {
        currentPage = 1;
        await LoadEntries();
    }

    private async Task OnMoodFilterChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        selectedMood = string.IsNullOrEmpty(value) ? null : Enum.Parse<MoodType>(value);
        currentPage = 1;
        await LoadEntries();
    }

    private async Task OnTagFilterChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        selectedTagId = string.IsNullOrEmpty(value) ? null : int.Parse(value);
        currentPage = 1;
        await LoadEntries();
    }

    private async Task ClearFilters()
    {
        searchTerm = "";
        selectedMood = null;
        selectedTagId = null;
        currentPage = 1;
        await LoadEntries();
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadEntries();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadEntries();
        }
    }

    private void NewEntry() => Nav.NavigateTo("/journal/new");
    private void ViewEntry(int id) => Nav.NavigateTo($"/journal/{id}");
    private void EditEntry(int id) => Nav.NavigateTo($"/journal/edit/{id}");

    private async Task DeleteEntry(int id)
    {
        await JournalService.DeleteEntryAsync(id);
        await LoadEntries();
    }

    private string TruncateContent(string content)
    {
        return content.Length > 100 ? content[..100] + "..." : content;
    }

    private string GetMoodEmoji(MoodType mood) => mood switch
    {
        MoodType.Happy => "üòä",
        MoodType.Sad => "üò¢",
        MoodType.Neutral => "üòê",
        MoodType.Anxious => "üò∞",
        MoodType.Excited => "ü§©",
        MoodType.Grateful => "üôè",
        MoodType.Stressed => "üò´",
        _ => "üòê"
    };
}
