@page "/journal/{Id:int}"
@using MauiApp3.Models
@using MauiApp3.Services
@inject IJournalService JournalService
@inject NavigationManager Nav

<div class="detail-page">
    @if (entry == null)
    {
        <div class="loading">Loading...</div>
    }
    else
    {
        <div class="detail-header">
            <button class="btn-secondary" @onclick="GoBack">â† Back</button>
            <div class="detail-actions">
                <button class="btn-secondary" @onclick="EditEntry">âœï¸ Edit</button>
                <button class="btn-danger" @onclick="DeleteEntry">ğŸ—‘ï¸ Delete</button>
            </div>
        </div>

        <div class="detail-card">
            <div class="detail-mood">
                <span class="mood-large">@GetMoodEmoji(entry.Mood)</span>
                <span class="mood-label">@entry.Mood</span>
                @if (entry.SecondaryMood1.HasValue)
                {
                    <span class="mood-secondary">@GetMoodEmoji(entry.SecondaryMood1.Value)</span>
                }
                @if (entry.SecondaryMood2.HasValue)
                {
                    <span class="mood-secondary">@GetMoodEmoji(entry.SecondaryMood2.Value)</span>
                }
            </div>

            <h1 class="detail-title">@entry.Title</h1>

            <div class="detail-meta">
                <span>ğŸ“… @entry.EntryDate.ToString("MMMM dd, yyyy")</span>
                <span>ğŸ“ @entry.WordCount words</span>
                @if (entry.UpdatedAt != entry.CreatedAt)
                {
                    <span>âœï¸ Edited @entry.UpdatedAt.ToLocalTime().ToString("MMM dd, yyyy")</span>
                }
            </div>

            @if (entry.JournalEntryTags?.Any() == true)
            {
                <div class="detail-tags">
                    @foreach (var jt in entry.JournalEntryTags)
                    {
                        <span class="tag-badge">@jt.Tag?.Name</span>
                    }
                </div>
            }

            <div class="detail-content">
                @foreach (var paragraph in entry.Content.Split('\n', StringSplitOptions.RemoveEmptyEntries))
                {
                    <p>@RenderMarkdown(paragraph)</p>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private JournalEntry? entry;

    protected override async Task OnInitializedAsync()
    {
        entry = await JournalService.GetEntryByIdAsync(Id);
        if (entry == null)
        {
            Nav.NavigateTo("/journal");
        }
    }

    private void GoBack() => Nav.NavigateTo("/journal");
    private void EditEntry() => Nav.NavigateTo($"/journal/edit/{Id}");

    private async Task DeleteEntry()
    {
        await JournalService.DeleteEntryAsync(Id);
        Nav.NavigateTo("/journal");
    }

    private MarkupString RenderMarkdown(string text)
    {
        // Simple markdown rendering
        var html = text
            .Replace("**", "<strong>").Replace("**", "</strong>")
            .Replace("*", "<em>").Replace("*", "</em>");
        return new MarkupString(html);
    }

    private string GetMoodEmoji(MoodType mood) => mood switch
    {
        MoodType.Happy => "ğŸ˜Š",
        MoodType.Sad => "ğŸ˜¢",
        MoodType.Neutral => "ğŸ˜",
        MoodType.Anxious => "ğŸ˜°",
        MoodType.Excited => "ğŸ¤©",
        MoodType.Grateful => "ğŸ™",
        MoodType.Stressed => "ğŸ˜«",
        _ => "ğŸ˜"
    };
}
